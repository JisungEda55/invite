<!DOCTYPE html>
<html lang="ko">
<head>
<meta charset="UTF-8" />
<meta name="viewport" content="width=device-width, initial-scale=1.0" />
<title>Serverless Invitation Engine</title>

<style>
body {
  margin:0;
  font-family: -apple-system, BlinkMacSystemFont, sans-serif;
  line-height:1.6;
}

section {
  padding:40px 20px;
  max-width:900px;
  margin:auto;
}

h1,h2 { margin-bottom:10px; }

button {
  padding:10px 16px;
  margin:5px 0;
  border:none;
  border-radius:8px;
  cursor:pointer;
}

input, textarea {
  width:100%;
  padding:8px;
  margin-bottom:10px;
}

.map-container iframe {
  width:100%;
  height:300px;
  border-radius:12px;
  border:0;
}

.card {
  padding:20px;
  border-radius:12px;
  margin-bottom:20px;
}

.dark { background:#111; color:white; }
.dark .card { background:#1e1e1e; }

.light { background:#f4f4f4; color:#111; }
.light .card { background:white; }

.builder {
  background:#222;
  color:white;
  padding:20px;
}

.hidden { display:none; }

.qr img { width:150px; }

.weather-box {
  padding:10px;
  border-radius:10px;
  margin-top:10px;
}
</style>
</head>

<body class="light">

<!-- ================= BUILDER ================= -->

<div id="builder" class="builder">
  <h2>초대장 생성기</h2>

  <input id="b_title" placeholder="행사명">
  <input id="b_subtitle" placeholder="서브타이틀">
  <input id="b_datetime" type="datetime-local">
  <input id="b_location_name" placeholder="장소명">
  <input id="b_address" placeholder="주소">
  <input id="b_lat" placeholder="위도">
  <input id="b_lng" placeholder="경도">
  <input id="b_city" placeholder="날씨 도시 (예: Seoul)">
  
  <select id="b_theme">
    <option value="light">Light</option>
    <option value="dark">Dark</option>
  </select>

  <button onclick="generateJSON()">JSON 생성</button>
  <button onclick="copyJSON()">JSON 복사</button>
  <button onclick="togglePreview()">미리보기 전환</button>

  <textarea id="output" rows="10"></textarea>
</div>

<!-- ================= INVITATION ================= -->

<section id="hero"></section>
<section id="countdown"></section>
<section id="location"></section>
<section id="weather"></section>
<section id="calendar"></section>
<section id="qr"></section>
<section id="guestbook"></section>

<!-- ================= DATA ================= -->

<script id="event-data" type="application/json">
{
  "meta":{"theme":"light"},
  "event":{
    "title":"샘플 행사",
    "subtitle":"환영합니다",
    "dateTime":"2026-03-14T18:00"
  },
  "location":{
    "name":"서울 시청",
    "address":"서울특별시 중구 세종대로 110",
    "lat":37.5665,
    "lng":126.9780,
    "zoom":16
  },
  "weather":{"enabled":true,"city":"Seoul"},
  "extensions":{
    "countdown":true,
    "map":true,
    "waze":true,
    "qr":true,
    "calendar":true,
    "guestbook":true
  }
}
</script>

<script>
let eventData;

function loadData(){
  const raw=document.getElementById("event-data").textContent;
  eventData=JSON.parse(raw);
  document.body.className=eventData.meta.theme;
  renderAll();
}

function renderAll(){
  renderHero();
  if(eventData.extensions.countdown) renderCountdown();
  if(eventData.extensions.map) renderMap();
  if(eventData.weather.enabled) renderWeather();
  if(eventData.extensions.calendar) renderCalendar();
  if(eventData.extensions.qr) renderQR();
  if(eventData.extensions.guestbook) renderGuestbook();
}

function renderHero(){
  document.getElementById("hero").innerHTML=`
    <div class="card">
      <h1>${eventData.event.title}</h1>
      <p>${eventData.event.subtitle}</p>
      <p>${new Date(eventData.event.dateTime).toLocaleString()}</p>
    </div>`;
}

function renderCountdown(){
  const target=new Date(eventData.event.dateTime);
  const now=new Date();
  const diff=target-now;
  const days=Math.floor(diff/(1000*60*60*24));
  document.getElementById("countdown").innerHTML=
  `<div class="card">D-${days}</div>`;
}

function renderMap(){
  const l=eventData.location;
  const mapUrl=`https://www.google.com/maps?q=${l.lat},${l.lng}&z=${l.zoom}&output=embed`;
  const waze=`https://waze.com/ul?ll=${l.lat},${l.lng}&navigate=yes`;
  document.getElementById("location").innerHTML=`
    <div class="card">
      <h2>장소</h2>
      <p>${l.name}</p>
      <p>${l.address}</p>
      <div class="map-container">
        <iframe src="${mapUrl}" loading="lazy"></iframe>
      </div>
      <a href="${waze}" target="_blank"><button>Waze 길찾기</button></a>
    </div>`;
}

async function renderWeather(){
  const cache=localStorage.getItem("weatherCache");
  let data;
  if(cache){
    const parsed=JSON.parse(cache);
    if(Date.now()-parsed.time<3600000){
      data=parsed.data;
    }
  }
  if(!data){
    const res=await fetch(`https://wttr.in/${eventData.weather.city}?format=j1`);
    data=await res.json();
    localStorage.setItem("weatherCache",JSON.stringify({time:Date.now(),data}));
  }
  const temp=data.current_condition[0].temp_C;
  const desc=data.current_condition[0].weatherDesc[0].value;
  document.getElementById("weather").innerHTML=
    `<div class="card weather-box">현재 날씨: ${temp}°C / ${desc}</div>`;
}

function renderCalendar(){
  document.getElementById("calendar").innerHTML=
    `<div class="card">
      <button onclick="downloadICS()">캘린더 추가</button>
    </div>`;
}

function downloadICS(){
  const e=eventData.event;
  const dt=new Date(e.dateTime).toISOString().replace(/[-:]/g,"").split(".")[0];
  const ics=`BEGIN:VCALENDAR
VERSION:2.0
BEGIN:VEVENT
SUMMARY:${e.title}
DTSTART:${dt}
END:VEVENT
END:VCALENDAR`;
  const blob=new Blob([ics],{type:"text/calendar"});
  const link=document.createElement("a");
  link.href=URL.createObjectURL(blob);
  link.download="event.ics";
  link.click();
}

function renderQR(){
  const url=location.href;
  const qr=`https://api.qrserver.com/v1/create-qr-code/?size=200x200&data=${encodeURIComponent(url)}`;
  document.getElementById("qr").innerHTML=
  `<div class="card qr"><h2>QR</h2><img src="${qr}"></div>`;
}

function renderGuestbook(){
  const saved=JSON.parse(localStorage.getItem("guestbook")||"[]");
  let list=saved.map(g=>`<p>${g}</p>`).join("");
  document.getElementById("guestbook").innerHTML=
  `<div class="card">
    <h2>방명록</h2>
    <input id="guestInput" placeholder="메시지 입력">
    <button onclick="addGuest()">등록</button>
    ${list}
  </div>`;
}

function addGuest(){
  const val=document.getElementById("guestInput").value;
  if(!val) return;
  const saved=JSON.parse(localStorage.getItem("guestbook")||"[]");
  saved.push(val);
  localStorage.setItem("guestbook",JSON.stringify(saved));
  loadData();
}

/* ================= BUILDER ================= */

function generateJSON(){
  const data={
    meta:{theme:document.getElementById("b_theme").value},
    event:{
      title:b_title.value,
      subtitle:b_subtitle.value,
      dateTime:b_datetime.value
    },
    location:{
      name:b_location_name.value,
      address:b_address.value,
      lat:parseFloat(b_lat.value),
      lng:parseFloat(b_lng.value),
      zoom:16
    },
    weather:{enabled:true,city:b_city.value},
    extensions:{
      countdown:true,map:true,waze:true,
      qr:true,calendar:true,guestbook:true
    }
  };
  output.value=JSON.stringify(data,null,2);
}

function copyJSON(){
  navigator.clipboard.writeText(output.value);
}

function togglePreview(){
  document.getElementById("builder").classList.toggle("hidden");
}

loadData();
</script>

</body>
</html>